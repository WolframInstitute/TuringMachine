name: Build Paclet

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build Paclet
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: false
          load: true
          tags: tms-build:latest

      - name: Build All Targets
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/opt/turingmachinesearch \
            tms-build:latest \
            /bin/bash -c "./build_all_targets.sh"

      - name: Build Paclet
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/opt/turingmachinesearch \
            -e WOLFRAMSCRIPT_ENTITLEMENTID=${{ secrets.WOLFRAMSCRIPT_ENTITLEMENTID }} \
            tms-build:latest \
            wolframscript -f docker_build.wl

      - name: Find Paclet File
        id: find_paclet
        run: |
          PACLET_FILE=$(find ${{ github.workspace }} -name "*.paclet" -type f | head -1)
          echo "paclet_file=$PACLET_FILE" >> $GITHUB_OUTPUT
          echo "Found paclet: $PACLET_FILE"

      - name: Upload Paclet Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TuringMachineSearch-paclet
          path: ${{ steps.find_paclet.outputs.paclet_file }}
          if-no-files-found: error
